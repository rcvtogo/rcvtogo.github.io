<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ranked Choice Voting (Multi-Device)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
    <style>
        .candidate-item {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .candidate-item:hover {
            background-color: #f3f4f6;
        }
        #voting-section {
            margin-bottom: 200vh;
        }
        .chart-container {
            max-width: 600px;
            margin: 20px auto;
            padding: 10px;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div class="container mx-auto p-6 max-w-3xl">
        <h1 class="text-3xl font-bold mb-6 text-center">Ranked Choice Voting (Multi-Device)</h1>

        <!-- Session ID display for sharing -->
        <div id="session-info" class="bg-blue-100 p-4 rounded mb-4 hidden">
            <p class="text-blue-800">Session ID: <span id="session-id-display"></span> | Share this URL with voters: <a id="share-url" href="#" target="_blank" class="underline">Click to copy</a></p>
        </div>

        <div id="define-candidates" class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-xl font-semibold mb-4">Define Candidates</h2>
            <p class="text-gray-600 mb-4">Enter up to 4 candidates. Each must have a unique name. (Admin only 1)</p>
            <div class="space-y-2">
                <input id="candidate1" type="text" placeholder="Candidate 1" class="w-full p-2 border rounded">
                <input id="candidate2" type="text" placeholder="Candidate 2" class="w-full p-2 border rounded">
                <input id="candidate3" type="text" placeholder="Candidate 3" class="w-full p-2 border rounded">
                <input id="candidate4" type="text" placeholder="Candidate 4" class="w-full p-2 border rounded">
                <input id="passcode" type="text" placeholder="Passcode" class="w-full p-2 border rounded">
            </div>
            <div class="flex space-x-2 mt-4">
                <button id="start-voting" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Start Voting</button>
                <button id="load-session" class="bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600">Load Existing Session</button>
                <button id="hide-section" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">Hide</button>
                <button id="pause-button" class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600">Pause</button>
            </div>
            <div id="load-session-div" class="hidden bg-gray-100 p-4 rounded mt-4 space-y-2">
                <label for="session-select" class="block text-sm font-medium text-gray-700">Select a session:</label>
                <select id="session-select" class="w-full p-2 border rounded">
                    <option value="">No sessions available</option>
                </select>
                <div class="flex space-x-2">
                    <button id="select-session" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 disabled:bg-gray-400" disabled>Select</button>
                    <button id="cancel-load" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Cancel</button>
                </div>
            </div>
        </div>
        <div id="passcode-prompt" class="bg-white p-6 rounded-lg shadow-md mb-6 hidden">
            <h2 class="text-xl font-semibold mb-4">Enter Passcode to Vote</h2>
            <input id="voter-passcode" type="text" placeholder="Passcode" class="w-full p-2 border rounded mb-4">
            <button id="submit-passcode" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Submit</button>
        </div>
        <div id="voting-section" class="bg-white p-6 rounded-lg shadow-md mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">Pick in Order of Preference, then click Submit Vote</h2>
                <span id="vote-count" class="text-gray-600"></span>
            </div>
            <p class="text-gray-600 mb-4" id="session-note" hidden>Session active. Votes sync across devices!</p>
            <div id="pause-message" class="hidden bg-yellow-100 border border-yellow-400 text-yellow-800 px-4 py-3 rounded mb-4">
                <strong>Voting Paused</strong><br>
                Please wait for the administrator to resume voting.
            </div>
            <div id="candidate-list" class="space-y-2">
                <!-- Candidates will be populated here -->
            </div>
            <div id="current-ranking" class="mt-4">
                <h3 class="font-semibold">Your Current Ranking:</h3>
                <ol id="ranking-list" class="list-decimal pl-6"></ol>
            </div>
            <button id="submit-vote" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 disabled:bg-gray-400" disabled>Submit Vote</button>
            <button id="undo-ranking" class="mt-4 ml-2 bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 disabled:bg-gray-400" disabled>Undo</button>
        </div>
        <div id="results-section" class="bg-white p-6 rounded-lg shadow-md">
            <h2 id="results-header" class="text-xl font-semibold mb-4">Results</h2>
            <div class="flex space-x-2 mb-4">
                <button id="show-results" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600 hidden disabled:bg-gray-400 disabled:opacity-50 disabled:cursor-not-allowed" disabled>Show Results</button>
                <button id="unhide-section" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 hidden">UnHide</button>
            </div>
            <div id="results" class="text-gray-600">
                <p>No votes submitted yet.</p>
            </div>
        </div>
    </div>
    <script>
// Your Firebase config (pasted exactly, with trailing / added to databaseURL)
    const firebaseConfig = {
        apiKey: "AIzaSyA0_6bomoTLz2rAC47xgov-ww-GJGpbXJ8",
        authDomain: "rcvfire01.firebaseapp.com",
        databaseURL: "https://rcvfire01-default-rtdb.firebaseio.com/", // Added trailing /
        projectId: "rcvfire01",
        storageBucket: "rcvfire01.firebasestorage.app",
        messagingSenderId: "383293127130",
        appId: "1:383293127130:web:474b8f9df829dbc856e8e3"
    };
    // Initialize Firebase (compat style)
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    // firebase.initializeApp(firebaseConfig);
    // const db = firebase.database();
        let candidates = [];
        let votes = []; // Local cache; syncs from DB
        let currentRanking = [];
        let sessionStartTime = null;
        let voteCounter = 0;
        let sessionId = null;
        let isAdmin = false; // NEW: Track admin mode
        let hasVoted = false;
        let resultsRevealed = false;
        let isPaused = false;
        let chartCounter = 0;
        let dbRef = null; // Session ref
        let votesRef = null; // Votes child ref
        let resultsRevealedRef = null; // Results revealed child ref
        let pausedRef = null; // Paused child ref
        let roundsRef = null; // Rounds child ref
        let roundsData = null;
        let passcode = null;
        function formatTimestamp(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${year}-${month}-${day}--${hours}-${minutes}-${seconds}`;
        }
        function checkVoteStatus() {
            if (isAdmin) return;
            const lastVoteKey = `lastVote_${sessionId}`;
            const lastVote = localStorage.getItem(lastVoteKey);
            const now = Date.now();
            const oneDay = 24 * 60 * 60 * 1000;
            if (lastVote) {
                const lastTime = parseInt(lastVote);
                if (now - lastTime < oneDay) {
                    hasVoted = true;
                    document.getElementById('voting-section').classList.add('hidden');
                    document.getElementById('session-info').classList.add('hidden');
                } else {
                    localStorage.removeItem(lastVoteKey);
                    hasVoted = false;
                    document.getElementById('voting-section').classList.remove('hidden');
                    document.getElementById('session-info').classList.remove('hidden');
                }
            } else {
                hasVoted = false;
                document.getElementById('voting-section').classList.remove('hidden');
                document.getElementById('session-info').classList.remove('hidden');
            }
            updateResultsVisibility();
        }
        // Fetch and populate session list
        function fetchSessionList() {
            const sessionsRef = db.ref('sessions');
            sessionsRef.once('value').then((snapshot) => {
                const sessions = [];
                snapshot.forEach((childSnapshot) => {
                    sessions.push(childSnapshot.key);
                });
                const select = document.getElementById('session-select');
                const selectBtn = document.getElementById('select-session');
                select.innerHTML = '';
                if (sessions.length === 0) {
                    select.innerHTML = '<option value="">No sessions available</option>';
                    selectBtn.disabled = true;
                } else {
                    // Sort sessions by key (timestamp)
                    sessions.sort();
                    sessions.forEach((session) => {
                        const option = document.createElement('option');
                        option.value = session;
                        option.textContent = session;
                        select.appendChild(option);
                    });
                    selectBtn.disabled = false;
                }
                document.getElementById('load-session-div').classList.remove('hidden');
            }).catch((error) => {
                console.error('Error fetching sessions:', error);
                alert('Error loading sessions. Please try again.');
                document.getElementById('load-session-div').classList.add('hidden');
            });
        }
        // Sync votes from DB to local cache
        function syncVotes() {
            if (!votesRef) return;
            votesRef.on('value', (snapshot) => {
                const dbVotes = snapshot.val() || [];
                votes = Array.isArray(dbVotes) ? dbVotes : [];
                // Filter invalid votes
                votes = votes.filter(vote => Array.isArray(vote) && vote.every(c => candidates.includes(c)));
                updateVoteCount();
                if (votes.length > 0) {
                    document.getElementById('results').innerHTML = '<p>Press "Show Results" to view the election outcome.</p>';
                } else {
                    document.getElementById('results').innerHTML = '<p>No votes submitted yet.</p>';
                }
                updateShowResultsButton();
            });
        }
        // Update show results button state
        function updateShowResultsButton() {
            const btn = document.getElementById('show-results');
            if (votes.length === 0) {
                btn.classList.add('hidden');
                return;
            }
            btn.classList.remove('hidden');
            if (!isAdmin) {
                btn.textContent = 'Results';
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                btn.textContent = 'Show Results';
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }
        // Update results visibility
        function updateResultsVisibility() {
            const header = document.getElementById('results-header');
            const resultsEl = document.getElementById('results');
            if (resultsRevealed) {
                header.classList.remove('hidden');
                resultsEl.classList.remove('hidden');
            } else if (!isAdmin && hasVoted) {
                header.classList.add('hidden');
                resultsEl.classList.add('hidden');
            } else {
                header.classList.remove('hidden');
                resultsEl.classList.remove('hidden');
            }
        }
        // Save state to DB
        function saveStateToDB() {
            if (!dbRef) return;
            if (votes.length === 0) {
                // Initial save
                dbRef.set({
                    candidates: candidates,
                    passcode: passcode,
                    votes: votes,
                    resultsRevealed: false,
                    paused: false,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
            } else {
                dbRef.update({ votes: votes });
            }
        }
        function updateVoteCount() {
            document.getElementById('vote-count').textContent = `Total Votes: ${votes.length}`;
        }
        function updateUndoButton() {
            const undoButton = document.getElementById('undo-ranking');
            if (!isAdmin && isPaused) {
                undoButton.disabled = true;
                return;
            }
            undoButton.disabled = currentRanking.length === 0;
        }
        function playSound(type) {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = ctx.createOscillator();
            const gainNode = ctx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(ctx.destination);
            if (type === 'submit') {
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(800, ctx.currentTime);
                gainNode.gain.setValueAtTime(0.5, ctx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
            }
            oscillator.start();
            oscillator.stop(ctx.currentTime + 0.5);
        }
        // UPDATED: Conditional UnHide button visibility (admin retains it)
        function toggleUnhideButton() {
            const unhideButton = document.getElementById('unhide-section');
            if (sessionId && !isAdmin) {
                // Voter mode: Hide the button
                unhideButton.classList.add('hidden');
            } else {
                // Admin mode: Show it
                unhideButton.classList.remove('hidden');
            }
        }
        function updatePauseButton() {
            if (!isAdmin) return;
            const btn = document.getElementById('pause-button');
            if (isPaused) {
                btn.textContent = 'Paused';
                btn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                btn.classList.add('bg-red-500', 'hover:bg-red-600');
            } else {
                btn.textContent = 'Pause';
                btn.classList.remove('bg-red-500', 'hover:bg-red-600');
                btn.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
            }
        }
        function updateVotingPauseState() {
            const messageEl = document.getElementById('pause-message');
            const candidateItems = document.querySelectorAll('.candidate-item');
            if (!isAdmin && isPaused) {
                messageEl.classList.remove('hidden');
                candidateItems.forEach(el => {
                    el.style.pointerEvents = 'none';
                    el.classList.add('opacity-50', 'cursor-not-allowed');
                });
            } else {
                messageEl.classList.add('hidden');
                candidateItems.forEach(el => {
                    el.style.pointerEvents = '';
                    el.classList.remove('opacity-50', 'cursor-not-allowed');
                });
            }
        }
        // Force non-admin to results mode
        function forceResultsMode() {
            document.getElementById('passcode-prompt').classList.add('hidden');
            document.getElementById('voting-section').classList.add('hidden');
            document.getElementById('session-info').classList.add('hidden');
            document.getElementById('results-header').classList.remove('hidden');
            document.getElementById('results').classList.remove('hidden');
            document.getElementById('define-candidates').classList.add('hidden');
            if (roundsData) displayResults(roundsData);
        }

        document.getElementById('load-session').addEventListener('click', fetchSessionList);

        document.getElementById('select-session').addEventListener('click', () => {
            const selectedId = document.getElementById('session-select').value;
            if (selectedId && selectedId.startsWith('session-')) {
                isAdmin = true;
                sessionId = selectedId;
                document.getElementById('load-session-div').classList.add('hidden');
                loadSession();
            }
        });
        document.getElementById('cancel-load').addEventListener('click', () => {
            document.getElementById('load-session-div').classList.add('hidden');
        });
        // Load session from DB
        function loadSession() {
            dbRef = db.ref(`sessions/${sessionId}`);
            votesRef = dbRef.child('votes');
            resultsRevealedRef = dbRef.child('resultsRevealed');
            pausedRef = dbRef.child('paused');
            roundsRef = dbRef.child('rounds');

            dbRef.once('value').then(snapshot => {
                const data = snapshot.val();
                if (data && data.candidates) {
                    candidates = data.candidates;
                    passcode = data.passcode || null;
                    votes = data.votes || [];
                    resultsRevealed = data.resultsRevealed || false;
                    isPaused = data.paused || false;
                    roundsData = data.rounds || null;
                    sessionStartTime = new Date(data.timestamp || Date.now());
                    document.getElementById('candidate1').value = candidates[0] || '';
                    document.getElementById('candidate2').value = candidates[1] || '';
                    document.getElementById('candidate3').value = candidates[2] || '';
                    document.getElementById('candidate4').value = candidates[3] || '';
                    currentRanking = [];
                    hasVoted = false;
                    syncVotes();

                    resultsRevealedRef.on('value', snap => {
                        resultsRevealed = snap.val() || false;
                        updateShowResultsButton();
                        updateResultsVisibility();
                        if (resultsRevealed && roundsData) displayResults(roundsData);
                        if (resultsRevealed && !isAdmin) forceResultsMode();
                    });

                    pausedRef.on('value', snap => {
                        isPaused = snap.val() || false;
                        if (isAdmin) updatePauseButton();
                        updateSubmitButton();
                        updateUndoButton();
                        updateVotingPauseState();
                    });

                    roundsRef.on('value', snap => {
                        roundsData = snap.val() || null;
                        if (resultsRevealed && roundsData) displayResults(roundsData);
                    });

                    if (resultsRevealed && roundsData) displayResults(roundsData);
                    if (isAdmin) updatePauseButton();

                    if (resultsRevealed && !isAdmin) {
                        forceResultsMode();
                    } else if (!isAdmin && passcode && passcode.trim() !== '') {
                        // Show passcode prompt, hide everything else
                        document.getElementById('passcode-prompt').classList.remove('hidden');
                        ['session-info','voting-section','results-section','define-candidates']
                            .forEach(id => document.getElementById(id)?.classList.add('hidden'));
                    } else {
                        // Normal flow: populate and show
                        populateCandidates();
                        updateRankingDisplay();
                        updateUndoButton();
                        updateVoteCount();
                        updateShowResultsButton();
                        updateResultsVisibility();
                        document.getElementById('define-candidates').classList.add('hidden');
                        document.getElementById('session-info').classList.remove('hidden');
                        document.getElementById('session-id-display').textContent = sessionId;
                        const url = new URL(window.location.href);
                        url.searchParams.set('session', sessionId);
                        document.getElementById('share-url').href = url.toString();
                        document.getElementById('session-note').classList.remove('hidden');
                        checkVoteStatus();
                        toggleUnhideButton();
                    }
                } else {
                    alert('Session not found. Start a new one.');
                    isAdmin = false;
                    toggleUnhideButton();
                }
            });
        }
        document.getElementById('submit-passcode').addEventListener('click', () => {
            const entered = document.getElementById('voter-passcode').value.trim();
            if (entered === passcode) {
                // Success: show sections and initialize
                document.getElementById('passcode-prompt').classList.add('hidden');
                populateCandidates();
                updateRankingDisplay();
                updateUndoButton();
                updateVoteCount();
                updateShowResultsButton();
                updateResultsVisibility();
                document.getElementById('session-info').classList.remove('hidden');
                document.getElementById('voting-section').classList.remove('hidden');
                document.getElementById('results-section').classList.remove('hidden');
                document.getElementById('session-id-display').textContent = sessionId;
                const url = new URL(window.location.href);
                url.searchParams.set('session', sessionId);
                document.getElementById('share-url').href = url.toString();
                document.getElementById('session-note').classList.remove('hidden');
                checkVoteStatus();
                toggleUnhideButton();
                updateVotingPauseState();
            } else {
                alert('Incorrect passcode. Please try again.');
                document.getElementById('voter-passcode').value = '';
            }
        });

        document.getElementById('voter-passcode').addEventListener('keydown', e => {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('submit-passcode').click();
            }
        });
        // Check URL for session ID on load
        window.addEventListener('load', () => {
            const params = new URLSearchParams(window.location.search);
            sessionId = params.get('session');
            isAdmin = !sessionId;
            if (sessionId) loadSession();
            toggleUnhideButton();
        });
        document.getElementById('hide-section').addEventListener('click', () => {
            document.getElementById('define-candidates').classList.add('hidden');
        });
        document.getElementById('unhide-section').addEventListener('click', () => {
            document.getElementById('define-candidates').classList.remove('hidden');
        });
        document.getElementById('pause-button').addEventListener('click', () => {
            if (!isAdmin) return;
            isPaused = !isPaused;
            updatePauseButton();
            dbRef.update({ paused: isPaused });
        });
        // Start voting -> save to DB
        document.getElementById('start-voting').addEventListener('click', () => {
            const inputs = [
                document.getElementById('candidate1').value.trim(),
                document.getElementById('candidate2').value.trim(),
                document.getElementById('candidate3').value.trim(),
                document.getElementById('candidate4').value.trim()
            ];
            const passcodeValue = document.getElementById('passcode').value.trim();
            candidates = inputs.filter(n => n !== '').slice(0,4);

            if (new Set(candidates).size !== candidates.length) {
                alert('Candidate names must be unique.');
                return;
            }
            if (candidates.length < 2) {
                alert('At least 2 candidates required.');
                return;
            }
            sessionStartTime = new Date();
            sessionId = `session-${formatTimestamp(sessionStartTime)}`;
            passcode = passcodeValue;
            isAdmin = true; // UPDATED: Ensure admin retains mode after start
            votes = [];
            resultsRevealed = false;
            isPaused = false;
            hasVoted = false;
            roundsData = null;
            dbRef = db.ref(`sessions/${sessionId}`);
            votesRef = dbRef.child('votes');
            resultsRevealedRef = dbRef.child('resultsRevealed');
            pausedRef = dbRef.child('paused');
            roundsRef = dbRef.child('rounds');
            saveStateToDB(); // Initial save
            document.getElementById('results').innerHTML = '<p>No votes submitted yet.</p>';
            currentRanking = [];
            populateCandidates();
            updateRankingDisplay();
            updateUndoButton();
            updateVoteCount();
            updateShowResultsButton();
            updateResultsVisibility();
            document.getElementById('define-candidates').classList.add('hidden');
            document.getElementById('session-info').classList.remove('hidden');
            document.getElementById('session-id-display').textContent = sessionId;
            const url = new URL(window.location.href);
            url.searchParams.set('session', sessionId);
            document.getElementById('share-url').href = url.toString();
            document.getElementById('session-note').classList.remove('hidden');
            syncVotes();

            resultsRevealedRef.on('value', snap => {
                resultsRevealed = snap.val() || false;
                updateShowResultsButton();
                updateResultsVisibility();
                if (resultsRevealed && roundsData) displayResults(roundsData);
                if (resultsRevealed && !isAdmin) forceResultsMode();
            });

            pausedRef.on('value', snap => {
                isPaused = snap.val() || false;
                if (isAdmin) updatePauseButton();
                updateSubmitButton();
                updateUndoButton();
                updateVotingPauseState();
            });

            roundsRef.on('value', snap => {
                roundsData = snap.val() || null;
                if (resultsRevealed && roundsData) displayResults(roundsData);
            });

            if (isAdmin) updatePauseButton();
            checkVoteStatus();
            toggleUnhideButton();
            updateVotingPauseState();
        });
        function populateCandidates() {
            const list = document.getElementById('candidate-list');
            list.innerHTML = '';
            const shuffled = [...candidates].sort(() => Math.random() - 0.5);
            shuffled.forEach(cand => {
                const div = document.createElement('div');
                div.className = 'candidate-item flex items-center p-2 bg-gray-50 border rounded';
                div.innerHTML = `<span>${cand}</span>`;
                div.addEventListener('click', () => handleCandidateClick(cand, div));
                list.appendChild(div);
            });
            updateSubmitButton();
            updateUndoButton();
            updateVotingPauseState();
        }
        function handleCandidateClick(candidate, element) {
            if (!isAdmin && isPaused) return;
            if (!currentRanking.includes(candidate)) {
                currentRanking.push(candidate);
                element.remove();
                const remaining = candidates.filter(c => !currentRanking.includes(c));
                if (remaining.length === 1) {
                    currentRanking.push(remaining[0]);
                    document.getElementById('candidate-list').innerHTML = '';
                }
                updateRankingDisplay();
                updateSubmitButton();
                updateUndoButton();
            }
        }
        function updateRankingDisplay() {
            const ol = document.getElementById('ranking-list');
            ol.innerHTML = '';
            currentRanking.forEach(c => {
                const li = document.createElement('li');
                li.textContent = c;
                ol.appendChild(li);
            });
        }
        function updateSubmitButton() {
            const btn = document.getElementById('submit-vote');
            if (!isAdmin && isPaused) {
                btn.disabled = true;
                return;
            }
            btn.disabled = currentRanking.length !== candidates.length;
        }
        document.getElementById('undo-ranking').addEventListener('click', () => {
            if (!isAdmin && isPaused) return;
            currentRanking = [];
            populateCandidates();
            updateRankingDisplay();
            updateUndoButton();
        });

        document.getElementById('submit-vote').addEventListener('click', () => {
            if (currentRanking.length !== candidates.length) return;
            if (!isAdmin && isPaused) {
                alert('Voting is paused. Please wait for the administrator to resume.');
                return;
            }
            if (!isAdmin) {
                const key = `lastVote_${sessionId}`;
                const last = localStorage.getItem(key);
                if (last) {
                    if (Date.now() - parseInt(last) < 24*60*60*1000) {
                        alert('You already voted today.');
                        return;
                    }
                }
            }
            playSound('submit');
            votes.push([...currentRanking]);
            voteCounter++;
            saveStateToDB();
            currentRanking = [];
            populateCandidates();
            updateRankingDisplay();
            updateUndoButton();
            updateVoteCount();
            if (!isAdmin) {
                localStorage.setItem(`lastVote_${sessionId}`, Date.now().toString());
                document.getElementById('voting-section').classList.add('hidden');
                document.getElementById('session-info').classList.add('hidden');
                hasVoted = true;
                updateResultsVisibility();
            }
            updateShowResultsButton();
        });
        document.getElementById('show-results').addEventListener('click', () => {
            if (!isAdmin) return;
            const rounds = [];
            compute_rcv_winner(votes, new Set(candidates), rounds);

            const serialized = rounds.map(r => ({
                candidates: Array.from(r.candidates),
                counts: Object.fromEntries(r.counts),
                eliminated: r.eliminated,
                winner: r.winner,
                majority: r.majority,           // now [round, fraction]
                randomChoice: r.randomChoice
            }));
            dbRef.update({
                rounds: serialized,
                resultsRevealed: true
            });

            displayResults(serialized);
        });

        // ──────────────────────────────────────────────────────────────
        //   HELPER: Compare two majority tuples [round, fraction]
        //   Returns:  1 if a is better, -1 if b is better, 0 if equal
        // ──────────────────────────────────────────────────────────────
        function compareMajorityTuples(a, b) {
            if (a[0] !== b[0]) {
                return b[0] - a[0];  // smaller round number is BETTER
            }
            return a[1] - b[1];      // then higher percentage
        }

        function compute_rcv_winner(ballots, candidates = null, rounds = null) {
            try {
                if (!Array.isArray(ballots) || ballots.length === 0) {
                    throw new Error('No ballots provided');
                }

                if (!candidates) {
                    candidates = new Set(ballots.flat().filter(c => typeof c === 'string' && c));
                } else if (candidates instanceof Set) {
                    candidates = new Set(candidates);
                } else {
                    candidates = new Set(candidates);
                }

                const currentRound = rounds ? rounds.length + 1 : 1;

                let counts = new Map([...candidates].map(c => [c, 0]));
                for (const ballot of ballots) {
                    if (!Array.isArray(ballot)) continue;
                    for (const choice of ballot) {
                        if (candidates.has(choice)) {
                            counts.set(choice, (counts.get(choice) || 0) + 1);
                            break;
                        }
                    }
                }

                if (rounds) {
                    rounds.push({
                        candidates: new Set(candidates),
                        counts: new Map(counts),
                        eliminated: null,
                        winner: null,
                        majority: null,
                        randomChoice: false
                    });
                }

                const values = [...counts.values()];
                const total = values.reduce((a,b)=>a+b,0) || 1;

                // Check for majority winner
                for (const [cand, cnt] of counts) {
                    if (cnt > total / 2) {
                        const majorityTuple = [currentRound, cnt / total];
                        if (rounds) {
                            rounds[rounds.length-1].winner = cand;
                            rounds[rounds.length-1].majority = majorityTuple;
                        }
                        return [cand, majorityTuple];
                    }
                }

                // All remaining candidates tied (very rare)
                if (values.every(v => v === values[0]) && values[0] !== 0) {
                    const winner = [...candidates][Math.floor(Math.random() * candidates.size)];
                    const majorityTuple = [currentRound, 1 / candidates.size];
                    if (rounds) {
                        rounds[rounds.length-1].winner = winner;
                        rounds[rounds.length-1].majority = majorityTuple;
                        rounds[rounds.length-1].randomChoice = true;
                    }
                    return [winner, majorityTuple];
                }

                // Eliminate zero-vote candidates first
                const zeroVote = [...counts].filter(([,v]) => v === 0).map(([c]) => c);
                if (zeroVote.length > 0) {
                    if (rounds) {
                        rounds[rounds.length-1].eliminated = zeroVote.join(', ');
                    }
                    zeroVote.forEach(c => candidates.delete(c));
                    if (candidates.size === 0) throw new Error('All candidates eliminated');
                    return compute_rcv_winner(ballots, candidates, rounds);
                }

                // Find candidates with fewest votes
                const minVotes = Math.min(...values.filter(v => v > 0));
                const lowest = [...counts].filter(([,v]) => v === minVotes).map(([c]) => c);

                if (lowest.length === 1) {
                    if (rounds) rounds[rounds.length-1].eliminated = lowest[0];
                    candidates.delete(lowest[0]);
                    if (candidates.size === 0) throw new Error('All candidates eliminated');
                    return compute_rcv_winner(ballots, candidates, rounds);
                }

                // ─── TIE-BREAKER: Look ahead for best future majority ───
                let bestMajority = [-Infinity, -Infinity];  // impossible value
                let bestElims = [];
                let bestWinners = [];

                for (const elim of lowest) {
                    const nextCandidates = new Set(candidates);
                    nextCandidates.delete(elim);

                    for (let i = 0; i < 100; i++) {
                        const [, majorityTuple] = compute_rcv_winner(ballots, nextCandidates, null);

                        const cmp = compareMajorityTuples(majorityTuple, bestMajority);
                        if (cmp > 0) {
                            bestMajority = majorityTuple;
                            bestElims = [elim];
                            bestWinners = [majorityTuple[2]]; // winner is 1st element of return
                        } else if (cmp === 0) {
                            bestElims.push(elim);
                            bestWinners.push(majorityTuple[2]);
                        }
                    }
                }

                const chosen = bestElims[Math.floor(Math.random() * bestElims.length)];

                if (rounds) {
                    let msg = chosen;
                    if (new Set(bestWinners).size === 1) {
                        if (bestElims.length > 1) msg += ' (multiple equivalent choices)';
                        else msg += ' (best majority score)';
                    } else {
                        msg += ' (random among best future outcomes)';
                    }
                    rounds[rounds.length-1].eliminated = msg;
                    rounds[rounds.length-1].randomChoice = new Set(bestWinners).size >= 2;
                }

                candidates.delete(chosen);
                if (candidates.size === 0) throw new Error('All candidates eliminated');
                return compute_rcv_winner(ballots, candidates, rounds);

            } catch (e) {
                console.error('RCV error:', e);
                throw e;
            }
        }

        function displayResults(storedRounds) {
            const resultsDiv = document.getElementById('results');
            if (!candidates?.length || candidates.length < 2) {
                resultsDiv.innerHTML = '<p>Invalid candidates.</p>';
                return;
            }
            if (!storedRounds?.length) {
                resultsDiv.innerHTML = '<p>No results yet.</p>';
                return;
            }
            resultsDiv.innerHTML = '';

            const colors = [
                { bg: '#00A000', border: '#008000' },
                { bg: '#1976D2', border: '#0D47A1' },
                { bg: '#00d3d3', border: '#008080' },
                { bg: '#891fb6', border: '#6a1b9a' }
            ];

            const candidateColors = {};
            candidates.forEach((c, i) => candidateColors[c] = colors[i % colors.length]);

            const anyRandom = storedRounds.some(r => r.randomChoice);

            storedRounds.forEach((round, idx) => {
                const roundDiv = document.createElement('div');
                roundDiv.innerHTML = `<h3 class="font-semibold mt-6 text-lg">Round ${idx + 1}</h3>`;

                const ul = document.createElement('ul');
                ul.className = 'list-disc pl-6 mb-4';
                const sorted = [...round.candidates].sort();
                sorted.forEach(c => {
                    const li = document.createElement('li');
                    li.textContent = `${c}: ${round.counts[c] || 0} votes`;
                    ul.appendChild(li);
                });
                roundDiv.appendChild(ul);

                const chartId = `chart-${idx}-${Date.now()}`;
                const container = document.createElement('div');
                container.className = 'chart-container';
                container.innerHTML = `<canvas id="${chartId}" height="${sorted.length * 45}"></canvas>`;
                roundDiv.appendChild(container);

                resultsDiv.appendChild(roundDiv);

                try {
                    new Chart(document.getElementById(chartId), {
                        type: 'bar',
                        data: {
                            labels: sorted,
                            datasets: [{
                                label: `Round ${idx + 1}`,
                                data: sorted.map(c => round.counts[c] || 0),
                                backgroundColor: sorted.map(c => candidateColors[c]?.bg || '#9e9e9e'),
                                borderColor: sorted.map(c => candidateColors[c]?.border || '#757575'),
                                borderWidth: 1
                            }]
                        },
                        options: {
                            indexAxis: 'y',
                            scales: {
                                x: { beginAtZero: true, title: { display: true, text: 'Votes' } }
                            },
                            plugins: { legend: { display: false } }
                        }
                    });
                } catch (e) {
                    console.error('Chart error:', e);
                }

                if (round.eliminated) {
                    const p = document.createElement('p');
                    p.className = 'mt-2 text-gray-700';
                    p.textContent = `Eliminated: ${round.eliminated}${round.randomChoice ? ' (tie → random)' : ''}`;
                    roundDiv.appendChild(p);
                }

                if (round.winner) {
                    const perc = (round.majority[1] * 100).toFixed(2);
                    const rnum = round.majority[0];
                    const p = document.createElement('p');
                    p.className = 'font-bold mt-3 text-lg';
                    p.textContent = `Winner: ${round.winner} — ${perc}% (Round ${rnum})${anyRandom ? ' (tie/random involved)' : ''}`;
                    roundDiv.appendChild(p);
                }
            });
        }
        updateVoteCount();
    </script>
</body>
</html>